#language: bash
sudo: true
dist: xenial
language: node_js
node_js: '10'
services:
  - docker
  - xvfb

cache:
  directories:
    - ~/.npm # cache npm's cache
    - ~/.cargo # cache cargo's cache
    # cache built artifacts from install phase to speedup e2e
    - build 
    - artifacts
 
env:
  global:
    # runtime versions
    - RUST_VERSION=1.32.0
    # browser versions
    - FIREFOX_NIGHTLY=67.0b8
    - CHROME_VERSION=google-chrome-stable
    # Xorg config
    - SCREEN_RESOLUTION=1280x1024x24
    # docker images
    - E2E_BRAVE_DOCKER_IMAGE=rcmorano/circleci-node-8-browsers:brave
    - E2E_CHROME_DOCKER_IMAGE=circleci/node:8-browsers
    - E2E_FIREFOX_DOCKER_IMAGE=rcmorano/circleci-node-8-browsers:firefox-nightly
    # misc
    - GIT_SHORT_COMMIT=${TRAVIS_COMMIT:0:7}
    - CARDANO_NETWORK=mainnet

before_install:
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  - >
    if [ ! -e "$HOME/.cargo/bin" ];
    then
      curl https://sh.rustup.rs -sSf | sh -s -- -y;
      rustup install ${RUST_VERSION};
      rustup target add wasm32-unknown-unknown --toolchain ${RUST_VERSION}
    fi;
    sudo ln -s $HOME/.cargo/bin/* /usr/local/bin/;

install: 
  - npm ci

stages:
  - code-qa
  - build-yoroi
  - e2e-tests

_e2e_tests:
  # install brave, chrome or firefox
  install: &_e2e_tests_install
    - >
      set -euo pipefail;
      if [ "${BROWSER}" == "brave" ];
      then
        curl -s https://brave-browser-apt-release.s3.brave.com/brave-core.asc | sudo apt-key --keyring /etc/apt/trusted.gpg.d/brave-browser-release.gpg add -a;
        source /etc/lsb-release;
        echo "deb [arch=amd64] https://brave-browser-apt-release.s3.brave.com/ $DISTRIB_CODENAME main" | sudo tee /etc/apt/sources.list.d/brave-browser-release-${UBUNTU_CODENAME}.list;
        sudo apt-get update -qqy;
        sudo apt-get install -qqy brave-keyring brave-browser;
        BRAVE_VERSION=$(apt-cache policy brave-browser|grep -i installed | awk "{print \$NF}");
        curl -o /tmp/chromedriver_linux64.zip -L https://github.com/brave/brave-browser/releases/download/v${BRAVE_VERSION}/chromedriver-v${BRAVE_CHROMEDRIVER_VER}-linux-x64.zip;
        unzip /tmp/chromedriver_linux64.zip -d /tmp;
        rm -rf chromedriver_linux64.zip;
        sudo mv /tmp/chromedriver /usr/local/bin/chromedriver;
        sudo chmod +x /usr/local/bin/chromedriver;
      fi;
      if [ "${BROWSER}" == "chrome" ];
      then
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -;
        echo "deb http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list;
        apt-get update -qqy;
        apt-get install -qqy ${CHROME_VERSION:-google-chrome-stable};
        CHROME_STRING=$(google-chrome --version);
        CHROME_VERSION_STRING=$(echo "${CHROME_STRING}" | grep -oP "\d+\.\d+\.\d+\.\d+");
        CHROME_MAYOR_VERSION=$(echo "${CHROME_VERSION_STRING%%.*}");
        wget --no-verbose -O /tmp/LATEST_RELEASE "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_MAYOR_VERSION}";
        CD_VERSION=$(cat "/tmp/LATEST_RELEASE");
        rm /tmp/LATEST_RELEASE;
        if [ -z "$CHROME_DRIVER_VERSION" ]; \
        then
          CHROME_DRIVER_VERSION="${CD_VERSION}";
        fi;
        CD_VERSION=$(echo $CHROME_DRIVER_VERSION);
        echo "Using chromedriver version: "$CD_VERSION;
        wget --no-verbose -O /tmp/chromedriver_linux64.zip https://chromedriver.storage.googleapis.com/$CD_VERSION/chromedriver_linux64.zip;
        unzip /tmp/chromedriver_linux64.zip -d /tmp;
        rm -rf chromedriver_linux64.zip;
        sudo mv /tmp/chromedriver /usr/local/bin/chromedriver;
        sudo chmod +x /usr/local/bin/chromedriver;
      fi
      if [ "${BROWSER}" == "firefox" ];
      then
        curl -o /tmp/firefox-nightly.bz2 -sL https://download-installer.cdn.mozilla.net/pub/devedition/releases/${FIREFOX_NIGHTLY}/linux-x86_64/en-US/firefox-${FIREFOX_NIGHTLY}.tar.bz2;
        sudo tar -C /opt -jxf /tmp/firefox-nightly.bz2;
        sudo rm -f /opt/firefox/firefox;
        sudo rm -f /usr/local/bin/firefox;
        sudo ln -s /opt/firefox/firefox-bin /usr/local/bin/firefox;
      fi
      
  script: &_e2e_tests_script
    - >
      set -euo pipefail;
      echo ${DOCKER_IMAGE};
      ls -hl build;
      cp -a artifacts/*crx .;
      cp -a artifacts/*xpi .;
      xvfb-run --server-args="-screen 0 ${SCREEN_RESOLUTION}" npm run test-e2e-${BROWSER}

_build_yoroi_script:
  script: &_build_yoroi_script
    - >
      set -euo pipefail;
      if [ ! -e "build/${GIT_SHORT_COMMIT}.built" ];
      then
        echo Triggering by ${BROWSER} travisci to create caches;
        npm run test-prepare;
        mv *crx *xpi artifacts/;
        touch build/${GIT_SHORT_COMMIT}.built;
      fi 

matrix:
  fast_finish: true
  include:

    # This is to create cache for 'build' to be used in e2e-tests
    - stage: build-yoroi
      #if: branch = master
      name: "build Yoroi extension (brave)"
      env:
        - BROWSER=brave
        - DOCKER_IMAGE=${E2E_BRAVE_DOCKER_IMAGE}
      script: *_build_yoroi_script
    - stage: build-yoroi
      name: "build Yoroi extension (chrome)"
      env:
        - BROWSER=chrome
        - DOCKER_IMAGE=${E2E_CHROME_DOCKER_IMAGE}
      script: *_build_yoroi_script
    - stage: build-yoroi
      name: "build Yoroi extension (firefox)"
      env:
        - BROWSER=firefox
        - DOCKER_IMAGE=${E2E_FIREFOX_DOCKER_IMAGE}
      script: *_build_yoroi_script


    - stage: code-qa
      name: "flow checks"
      env: BROWSER=none
      script: npm run flow
    - stage: code-qa
      name: "eslint checks"
      env: BROWSER=none
      script: npm run eslint
    - stage: code-qa
      name: "jest checks"
      env: BROWSER=none
      script: npm run jest


    - stage: e2e-tests
      name: "Brave End-to-End tests"
      #if: branch = master
      env: 
        - BROWSER=brave
        - DOCKER_IMAGE=${E2E_BRAVE_DOCKER_IMAGE}
      install: *_e2e_tests_install
      script: *_e2e_tests_script
    - stage: e2e-tests
      name: "Chrome End-to-End tests"
      env:
        - BROWSER=chrome
        - DOCKER_IMAGE=${E2E_CHROME_DOCKER_IMAGE}
      install: *_e2e_tests_install
      script: *_e2e_tests_script
    - stage: e2e-tests
      name: "Firefox End-to-End tests"
      env:
        - BROWSER=firefox
        - DOCKER_IMAGE=${E2E_FIREFOX_DOCKER_IMAGE}
      install: *_e2e_tests_install
      script: *_e2e_tests_script


  allow_failures:
    - stage: build-docker
      script: true
          
notifications:
  slack:
    on_success: change
    on_failure: always
    # notify rcmorano
    secure: kHi8Xliok2qLhuSIZDIGHUfe8EEGFGyfHViBQP40zK7arvI/8kY5h1OtBVP/s/BE3DRdzlM9IJ7R+B7dM8wuKpWflEB9mkamy0wTvEnIS4gIEGd50kDt0bcTxcEgPfJM4IVPwwEQrhd+ftX6YJ4bEQJioDWz+GGCtJXCFtmTj+mvMiySUpKKckwJj2tPQmnS/dCPpgcjLe/GSD3dCpsFvx1jfT3OJkJjkAdmUQlcHsFEtzWgcdgIPUX6OtB75zO1BJyutvTZ04bkQCcO5pZzOjd99BPmF2wqaS/ukD2KcMWUadcpSdi0CGxUN5FH02JlmJd6C6Im03I4SKYE+PKE1EUstx+DQaQ2sKvhKoN2fmK0SgLt2V6X4vlG3c/ofWT/nH6HljayHpetdnNgGIk66Ry7BApIs7oj53Cqe0q8vwN6vHwFHetcPWNHi0B48BYMcaAyNLNQCYEa6QEmiLibWiWWMFRpM1SJTrOow78CSitfK6hsGpbFjoGd0gGXwLbhQFvOzWg7IbJ4dNwi7S21Tat4qBs//j5DT9QrofvRPh83HnLs6W3IRJpuGFfxHp5DRGCigB7VQlgEHZED010gbuBa7i5JMSCy0vyn13uX5HJ6xYDXGT0W8NFY3/pIATiQCD8hP1JzhgRjQxa4JeCsZH5gu7gKXwDkQcwF7ehL+jM=
